<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sistem Informasi RW 05 Digital - Dashboard</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;800&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
:root {
  --primary: #1e3a8a; --secondary: #3b82f6; --success: #10b981;
  --danger: #ef4444; --warning: #f59e0b; --lime: #a3ff00; --bg: #f1f5f9;
  --card-purple: #6f42c1; --card-blue: #0ea5e9; --card-green: #10b981; --card-red: #ef4444;
  --header-height: 70px;
  --sidebar-width: 260px;
}
body { font-family: 'Inter', sans-serif; margin: 0; background: var(--bg); color: #334155; min-height: 100vh; }

/* HEADER */
#header-app {
  position: fixed; top: 0; gap:10px; left: 0; z-index: 200;
  width: 100%; height: var(--header-height);
  background: #fff; border-bottom: 2px solid var(--primary);
  display: none; align-items: center; justify-content: flex-start;
  padding-left: 25px; font-size: 1.4rem; font-weight: 800; color: var(--primary); letter-spacing: 1px;
  box-shadow: 0 2px 8px rgba(30,58,138,0.04); box-sizing: border-box;
}
#header-app i { margin-right: 15px; font-size: 1.6rem; }

/* FOOTER APP */
#footer-app {
  width: 100%; background: #fff; color: #64748b; text-align: center; font-size: 0.9rem; font-weight: 500;
  border-top: 1px solid #e2e8f0; padding: 20px 0; margin-top: 40px; letter-spacing: 0.5px;
  display: none;
}

/* LOGIN PAGE */
#login-page { display: flex; justify-content: center; align-items: center; height: 100vh; background-color: var(--bg); position: relative; z-index: 999; }
.login-card { background: white; padding: 40px; border-radius: 12px; width: 100%; max-width: 400px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); text-align: center; border: 1px solid #e2e8f0; }
.login-card h2 { margin-bottom: 30px; color: var(--primary); font-weight: 800; letter-spacing: 1px; }
.form-login input { width: 100%; padding: 12px; margin-bottom: 20px; border: 1px solid #cbd5e1; border-radius: 8px; box-sizing: border-box; font-size: 1rem; }
.btn-login { width: 100%; padding: 14px; background-color: var(--lime); border: none; border-radius: 8px; font-weight: 800; cursor: pointer; text-transform: uppercase; transition: 0.3s; }
.btn-login:hover { filter: brightness(0.9); transform: translateY(-1px); }

/* SIDEBAR & LOGO */
#main-dashboard { display: none; margin-top: var(--header-height); }
.sidebar {
  width: var(--sidebar-width); height: calc(100vh - var(--header-height));
  background: var(--primary); color: white;
  position: fixed; top: var(--header-height); left: 0; z-index: 100; overflow-y: auto;
}
.sidebar-logo {
  display: flex; flex-direction: column; align-items: center;
  padding: 20px 0; border-bottom: 1px solid rgba(255,255,255,0.1); background: rgba(0,0,0,0.1);
}
#logo-preview {
  width: 80px; height: 80px; object-fit: contain; border-radius: 50%;
  background: #fff; border: 3px solid var(--secondary); margin-bottom: 10px; padding: 5px;
}
#logo-upload { display: none; }
.logo-upload-label { display: inline-block; cursor: pointer; color: #cbd5e1; font-size: 0.8rem; opacity: 0.7; transition: 0.2s; }
.logo-upload-label:hover { color: #fff; opacity: 1; }
.sidebar-brand { padding: 25px; text-align: center; border-bottom: 1px solid rgba(255,255,255,0.1); font-weight: bold; font-size: 1.1rem; text-transform: uppercase; letter-spacing: 1px; }
.nav-menu { padding: 15px; }
.nav-item { display: flex; align-items: center; gap: 10px; padding: 12px 15px; color: #cbd5e1; text-decoration: none; border-radius: 8px; margin-bottom: 8px; cursor: pointer; transition: 0.3s; }
.nav-item:hover, .nav-item.active { background: var(--secondary); color: white; }
.nav-item i { width: 20px; text-align: center; }

.main-content {
  margin-left: var(--sidebar-width); width: calc(100% - var(--sidebar-width));
  padding: 30px; box-sizing: border-box; min-height: calc(100vh - var(--header-height));
  display: flex; flex-direction: column;
}

/* COMPONENTS */
.section { display: none; animation: fadeIn 0.4s; flex-grow: 1; }
.section.active { display: block; }
.card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 25px; }
.header-flex { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid #e2e8f0; padding-bottom: 10px; }
.alert-banner { background: #dcfce7; border: 1px solid #86efac; color: #166534; padding: 20px; border-radius: 8px; margin-bottom: 25px; display: flex; justify-content: space-between; align-items: center; }

.dash-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-bottom: 30px; }
.stat-card { color: white; border-radius: 8px; position: relative; overflow: hidden; box-shadow: 0 4px 6px rgba(0,0,0,0.1); display: flex; flex-direction: column; justify-content: space-between; height: 140px; }
.stat-card.purple { background-color: var(--card-purple); }
.stat-card.blue { background-color: var(--card-blue); }
.stat-card.green { background-color: var(--card-green); }
.stat-card.red { background-color: var(--card-red); }
.stat-content { padding: 20px; z-index: 2; position: relative; }
.stat-value { font-size: 2.5rem; font-weight: 800; margin: 0; line-height: 1; }
.stat-label { font-size: 1rem; margin-top: 5px; opacity: 0.9; }
.stat-icon { position: absolute; top: 10px; right: 10px; font-size: 4rem; opacity: 0.2; z-index: 1; transform: rotate(-10deg); }
.stat-footer { background: rgba(0,0,0,0.15); padding: 10px 20px; text-align: center; cursor: pointer; transition: 0.2s; font-size: 0.85rem; display: flex; justify-content: center; align-items: center; gap: 8px; z-index: 3; }
.stat-footer:hover { background: rgba(0,0,0,0.25); }

/* TABLES & BADGES */
.table-container { overflow-x: auto; }
table { width: 100%; border-collapse: collapse; min-width: 800px; }
th { background: #f8fafc; padding: 12px; text-align: left; border-bottom: 2px solid #e2e8f0; color: #64748b; font-size: 0.8rem; text-transform: uppercase; }
td { padding: 12px; border-bottom: 1px solid #e2e8f0; font-size: 0.85rem; }
.badge { padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: bold; color: white; }
.badge-masuk { background-color: var(--success); }
.badge-keluar { background-color: var(--warning); }
.badge-lahir { background-color: var(--secondary); }
.badge-mati { background-color: var(--danger); }

/* MODALS */
.modal { display: none; position: fixed; z-index: 300; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); backdrop-filter: blur(2px); }
.modal-content { background: white; margin: 5% auto; padding: 25px; border-radius: 12px; width: 500px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
.form-group { margin-bottom: 15px; }
.form-group label { display: block; margin-bottom: 5px; font-weight: bold; font-size: 0.85rem; color: #475569; }
.form-group input, .form-group select, .form-group textarea { width: 100%; padding: 10px; border: 1px solid #cbd5e1; border-radius: 6px; box-sizing: border-box; font-family: inherit; }
.modal-footer { display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; }
.btn-add { padding: 10px 20px; background: var(--success); color: white; border-radius: 6px; border: none; cursor: pointer; font-weight: 600; }
.btn-del { background: var(--danger); color: white; font-size: 0.7rem; padding: 5px 8px; border: none; border-radius: 4px; cursor: pointer; }
.btn-cancel { background: #e2e8f0; color: #475569; padding: 10px 20px; border-radius: 6px; border: none; cursor: pointer; }

@keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
</style>
</head>
<body>

<div id="header-app">
  <i class="fa fa-building-user"></i>
  <span>SISTEM INFORMASI KEPENDUDUKAN RW 05 - Kampung Durian Runtuh </span>
</div>

<div id="login-page">
  <div class="login-card">
    <div style="font-size: 3.5rem; color: var(--primary); margin-bottom: 15px;"><i class="fa fa-id-card-clip"></i></div>
    <h2>LOGIN SIDK</h2>
    <div class="form-login">
      <label style="font-weight:600; font-size:0.9rem;">Username</label>
      <input type="text" id="username" placeholder="admin">
      <label style="font-weight:600; font-size:0.9rem;">Password</label>
      <input type="password" id="password" placeholder="admin">
      <button class="btn-login" onclick="handleLogin()">Masuk Sistem</button>
    </div>
    <p id="login-error" style="color:var(--danger); margin-top:15px; display:none; font-size:0.85rem; font-weight:bold;">Akses Ditolak!</p>
  </div>
</div>

<div id="main-dashboard">
  <div class="sidebar">
    <div class="sidebar-logo">
      <img id="logo-preview" src="https://via.placeholder.com/80?text=LOGO" alt="Logo Wilayah">
      <label for="logo-upload" class="logo-upload-label"><i class="fa fa-sync"></i> Ganti via Upload</label>
      <input type="file" id="logo-upload" accept="image/*">
    </div>
    <div class="sidebar-brand">MENU UTAMA</div>
    <div class="nav-menu">
      <div class="nav-item active" onclick="switchTab('home')"><i class="fa fa-home"></i> Home</div>
      <div class="nav-item" onclick="switchTab('penduduk')"><i class="fa fa-users"></i> Data Penduduk</div>
      <div class="nav-item" onclick="switchTab('kk')"><i class="fa fa-address-card"></i> Data KK</div>
      <div class="nav-item" onclick="switchTab('mutasi')"><i class="fa fa-exchange-alt"></i> Mutasi Warga</div>
      <div class="nav-item" onclick="switchTab('laporan')"><i class="fa fa-chart-bar"></i> Laporan</div>
      <div class="nav-item" onclick="switchTab('user')"><i class="fa fa-user-cog"></i> User</div>
      <div class="nav-item" onclick="location.reload()" style="margin-top: 50px; color: #ff8888;"><i class="fa fa-power-off"></i> Logout</div>
    </div>
  </div>

  <div class="main-content">
    <div id="content-wrapper">

      <div id="section-home" class="section active">
        <div class="alert-banner">
          <div><strong><i class="fa fa-bullhorn"></i> Selamat Datang, Admin!</strong><p style="margin:5px 0 0 0; font-size:0.9rem;">Sistem Informasi RW 05 siap digunakan.</p></div>
        </div>
        <div class="dash-grid">
          <div class="stat-card purple">
            <div class="stat-content"><h3 class="stat-value" id="dash-rt">0</h3><div class="stat-label">Wilayah RT Aktif</div></div>
            <i class="fa fa-map-marker-alt stat-icon"></i>
            <div class="stat-footer" onclick="gotoReportRT()">Detail <i class="fa fa-arrow-circle-right"></i></div>
          </div>
          <div class="stat-card blue">
            <div class="stat-content"><h3 class="stat-value" id="dash-penduduk">0</h3><div class="stat-label">Total Penduduk</div></div>
            <i class="fa fa-user stat-icon"></i>
            <div class="stat-footer" onclick="switchTab('penduduk')">Detail <i class="fa fa-arrow-circle-right"></i></div>
          </div>
          <div class="stat-card green">
            <div class="stat-content"><h3 class="stat-value" id="dash-kk">0</h3><div class="stat-label">Keluarga (KK)</div></div>
            <i class="fa fa-users stat-icon"></i>
            <div class="stat-footer" onclick="switchTab('kk')">Detail <i class="fa fa-arrow-circle-right"></i></div>
          </div>
          <div class="stat-card red">
            <div class="stat-content"><h3 class="stat-value" id="dash-mutasi">0</h3><div class="stat-label">Riwayat Mutasi</div></div>
            <i class="fa fa-exchange-alt stat-icon"></i>
            <div class="stat-footer" onclick="switchTab('mutasi')">Detail <i class="fa fa-arrow-circle-right"></i></div>
          </div>
        </div>
      </div>

      <div id="section-penduduk" class="section">
        <div class="header-flex"><h2>Data Penduduk</h2><button class="btn-add" onclick="openModal('modalPenduduk')">+ Tambah Warga</button></div>
        <div class="card">
          <div class="table-container">
            <table id="tablePenduduk"><thead><tr><th>NIK</th><th>Nama</th><th>JK</th><th>Agama</th><th>RT</th><th>Aksi</th></tr></thead><tbody></tbody></table>
          </div>
        </div>
      </div>

      <div id="section-kk" class="section">
        <div class="header-flex"><h2>Data Kartu Keluarga</h2><button class="btn-add" onclick="openModal('modalKK')">+ Tambah KK</button></div>
        <div class="card">
          <div class="table-container">
            <table id="tableKK"><thead><tr><th>No. KK</th><th>Kepala Keluarga</th><th>Alamat</th><th>RT</th><th>Aksi</th></tr></thead><tbody></tbody></table>
          </div>
        </div>
      </div>

      <div id="section-mutasi" class="section">
        <div class="header-flex"><h2>Riwayat Mutasi</h2><button class="btn-add" style="background:var(--card-red);" onclick="openModal('modalMutasi')">+ Input Mutasi</button></div>
        <div class="card">
          <div class="table-container">
            <table id="tableMutasi"><thead><tr><th>Tanggal</th><th>Nama</th><th>Jenis</th><th>Keterangan</th><th>Aksi</th></tr></thead><tbody></tbody></table>
          </div>
        </div>
      </div>

      <div id="section-user" class="section">
        <div class="header-flex"><h2>Manajemen User</h2><button class="btn-add" onclick="openModal('modalUser')">+ Tambah User</button></div>
        <div class="card"><div class="table-container"><table id="tableUser"><thead><tr><th>Username</th><th>Nama</th><th>Role</th><th>Aksi</th></tr></thead><tbody></tbody></table></div></div>
      </div>

      <div id="section-laporan" class="section">
        <div class="header-flex"><h2>Statistik Laporan</h2></div>
        <div class="card">
          <select id="sel_laporan" onchange="generateChart()" style="padding:10px; margin-bottom:20px; width:200px; border-radius:6px;">
            <option value="agama">Agama</option><option value="jk">Jenis Kelamin</option><option value="rt">Per RT</option>
          </select>
          <div style="height:350px;"><canvas id="myChart"></canvas></div>
        </div>
      </div>

    </div>
    <div id="footer-app">Copyright &copy; 2025 Sistem Informasi RW 05. All Rights Reserved.</div>
  </div>
</div>

<div id="modalPenduduk" class="modal"><div class="modal-content">
<h3>Tambah Warga</h3><hr>
<div class="form-group"><label>NIK</label><input type="text" id="p_nik"></div>
<div class="form-group"><label>Nama</label><input type="text" id="p_nama"></div>
<div class="form-group"><label>JK</label><select id="p_jk"><option value="L">Laki-laki</option><option value="P">Perempuan</option></select></div>
<div class="form-group"><label>Agama</label><select id="p_agama"><option>Islam</option><option>Kristen</option><option>Katolik</option><option>Hindu</option><option>Budha</option></select></div>
<div class="form-group"><label>RT</label><input type="text" id="p_rt" placeholder="01"></div>
<div class="form-group"><label>Alamat</label><input type="text" id="p_alamat"></div>
<div class="modal-footer"><button class="btn-add" onclick="addWarga()">Simpan</button><button class="btn-cancel" onclick="closeModal('modalPenduduk')">Batal</button></div>
</div></div>


<div id="modalKK" class="modal"><div class="modal-content">
<h3>Input KK</h3><hr>
<div class="form-group"><label>No KK</label><input type="text" id="kk_no"></div>
<div class="form-group"><label>Kepala Keluarga</label><input type="text" id="kk_kepala"></div>
<div class="form-group"><label>JK</label><select id="kk_jk"><option value="L">L</option><option value="P">P</option></select></div>
<div class="form-group"><label>RT</label><input type="text" id="kk_rt"></div>
<div class="form-group"><label>Alamat</label><input type="text" id="kk_alamat"></div>
<div class="modal-footer"><button class="btn-add" onclick="addKK()">Simpan</button><button class="btn-cancel" onclick="closeModal('modalKK')">Batal</button></div>
</div></div>

<div id="modalMutasi" class="modal"><div class="modal-content">
<h3>Input Mutasi</h3><hr>
<div class="form-group"><label>Tanggal</label><input type="date" id="m_tgl"></div>
<div class="form-group"><label>Nama Warga</label><input type="text" id="m_nama"></div>
<div class="form-group"><label>Jenis</label><select id="m_jenis"><option>Masuk</option><option>Keluar</option><option>Lahir</option><option>Mati</option></select></div>
<div class="form-group"><label>Keterangan</label><textarea id="m_ket"></textarea></div>
<div class="modal-footer"><button class="btn-add" style="background:var(--card-red);" onclick="addMutasi()">Simpan</button><button class="btn-cancel" onclick="closeModal('modalMutasi')">Batal</button></div>
</div></div>

<div id="modalUser" class="modal"><div class="modal-content">
<h3>Tambah User</h3><hr>
<div class="form-group"><label>Username</label><input type="text" id="u_username"></div>
<div class="form-group"><label>Nama</label><input type="text" id="u_nama"></div>
<div class="form-group"><label>Role</label><select id="u_role"><option>Admin</option><option>Operator</option></select></div>
<div class="modal-footer"><button class="btn-add" onclick="addUser()">Simpan</button><button class="btn-cancel" onclick="closeModal('modalUser')">Batal</button></div>
</div></div>

<script>
// DATABASE & STATE sementara
let db = { penduduk: [], kk: [], mutasi: [], user: [{username:'admin', nama:'Administrator', role:'Admin'}] };
let myChartInstance = null;

// Logo Management
window.addEventListener('DOMContentLoaded', function() {
  const logo = localStorage.getItem('sidk_logo');
  if (logo) {
    document.getElementById('logo-preview').src = logo;
  }
  // Tidak perlu else default karena sudah di-set di HTML sebagai placeholder

// untuk mengunggah logo baru dan menyimpannya dalam format Base64 ke LocalStorage
  document.getElementById('logo-upload').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if(file) {
      const reader = new FileReader();
      reader.onload = function(ev) {
        document.getElementById('logo-preview').src = ev.target.result;
        localStorage.setItem('sidk_logo', ev.target.result);
      };
      reader.readAsDataURL(file);
    }
  });
});

//INISIALISASI APLIKASI
window.onload = function() {
  document.getElementById('header-app').style.display = 'none';
  document.getElementById('footer-app').style.display = 'none';
  const saved = localStorage.getItem('sidk_database');
  if (saved) db = JSON.parse(saved);
  if (!db.mutasi) db.mutasi = [];
  renderAll();
};

//LOGIN
function handleLogin() {
  const u = document.getElementById('username').value;
  const p = document.getElementById('password').value;
  // SECURITY NOTE: In a real app, do not check passwords like this on the client side.
  if(u === 'admin' && p === 'admin') {
    document.getElementById('login-page').style.display = 'none';
    document.getElementById('header-app').style.display = 'flex';
    document.getElementById('main-dashboard').style.display = 'block';
    document.getElementById('footer-app').style.display = 'block';
    updateDashboardStats();
  } else { document.getElementById('login-error').style.display = 'block'; }
}

//NAVIGASI TAB
function switchTab(name) {
  document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  document.getElementById('section-' + name).classList.add('active');
  const navs = document.querySelectorAll('.nav-item');
  const indexMap = { home:0, penduduk:1, kk:2, mutasi:3, laporan:4, user:5 };
  if(indexMap[name] !== undefined) navs[indexMap[name]].classList.add('active');
  // Update data secara otomatis saat tab dibuka
  if(name === 'laporan') generateChart();
  if(name === 'home') updateDashboardStats();
}

function gotoReportRT() {
  switchTab('laporan');
  document.getElementById('sel_laporan').value = 'rt';
  generateChart();
}

//MODAL CONTROL
function openModal(id) { document.getElementById(id).style.display = 'block'; }
function closeModal(id) { document.getElementById(id).style.display = 'none'; }

function renderAll() {
  renderTable('penduduk'); renderTable('kk'); renderTable('mutasi'); renderTable('user');
  updateDashboardStats();
}

//RENDER TABEL
function renderTable(type) {
  const map = { penduduk: 'tablePenduduk', kk: 'tableKK', mutasi: 'tableMutasi', user: 'tableUser' };
  const tbody = document.querySelector(`#${map[type]} tbody`);
  tbody.innerHTML = "";
  db[type].forEach((item, idx) => {
    const row = tbody.insertRow();
    if(type === 'penduduk') row.innerHTML = `<td>${item.nik}</td><td>${item.nama}</td><td>${item.jk}</td><td>${item.agama}</td><td>${item.rt}</td><td><button class="btn-del" onclick="deleteData('penduduk',${idx})">Hapus</button></td>`;
    else if(type === 'kk') row.innerHTML = `<td>${item.no}</td><td>${item.kepala}</td><td>${item.alamat}</td><td>${item.rt}</td><td><button class="btn-del" onclick="deleteData('kk',${idx})">Hapus</button></td>`;
    else if(type === 'mutasi') {
      let b = item.jenis === 'Masuk' ? 'badge-masuk' : (item.jenis === 'Keluar' ? 'badge-keluar' : (item.jenis === 'Lahir' ? 'badge-lahir' : 'badge-mati'));
      // MEMPERBAIKI TAMPILAN TANGGAL DI TABEL
      let displayDate = item.tgl ? item.tgl : '-';
      row.innerHTML = `<td>${displayDate}</td><td>${item.nama}</td><td><span class="badge ${b}">${item.jenis}</span></td><td>${item.ket}</td><td><button class="btn-del" onclick="deleteData('mutasi',${idx})">Hapus</button></td>`;
    }
    else if(type === 'user') row.innerHTML = `<td>${item.username}</td><td>${item.nama}</td><td>${item.role}</td><td><button class="btn-del" onclick="deleteData('user',${idx})">Hapus</button></td>`;
  });
}

//FUNGSI TAMBAH DATA
function addWarga() {
  db.penduduk.push({ nik: p_nik.value, nama: p_nama.value, jk: p_jk.value, agama: p_agama.value, rt: p_rt.value, alamat: p_alamat.value });
  save('penduduk', 'modalPenduduk');
}
function addKK() {
  db.kk.push({ no: kk_no.value, kepala: kk_kepala.value, jk: kk_jk.value, alamat: kk_alamat.value, rt: kk_rt.value });
  save('kk', 'modalKK');
}
function addMutasi() {
  // MEMASTIKAN TANGGAL TERSIMPAN DARI INPUT DATE
  const tglValue = document.getElementById('m_tgl').value;
  db.mutasi.push({ tgl: tglValue, nama: m_nama.value, jenis: m_jenis.value, ket: m_ket.value });
  
  // Reset input tanggal setelah simpan agar bersih
  document.getElementById('m_tgl').value = '';
  
  save('mutasi', 'modalMutasi');
}
function addUser() {
  db.user.push({ username: u_username.value, nama: u_nama.value, role: u_role.value });
  save('user', 'modalUser');
}

//SIMPAN KE STORAGE
function save(type, mid) {
  localStorage.setItem('sidk_database', JSON.stringify(db));
  renderTable(type); updateDashboardStats(); closeModal(mid);
}

//HAPUS DATA
function deleteData(type, idx) {
  if(confirm("Hapus data?")) { db[type].splice(idx,1); localStorage.setItem('sidk_database', JSON.stringify(db)); renderTable(type); updateDashboardStats(); }
}

//STATISTIK DASHBOARD
function updateDashboardStats() {
  document.getElementById('dash-penduduk').innerText = db.penduduk.length;
  document.getElementById('dash-kk').innerText = db.kk.length;
  document.getElementById('dash-mutasi').innerText = db.mutasi.length;
  const rtSet = new Set(db.penduduk.map(p => p.rt));
  document.getElementById('dash-rt').innerText = rtSet.size || 0;
}

//GENERATE CHART
function generateChart() {
  const ctx = document.getElementById('myChart').getContext('2d');
  const type = document.getElementById('sel_laporan').value;
  if (myChartInstance) myChartInstance.destroy();
  let labels = [], data = [], chartType = 'pie', colors = ['#3b82f6', '#ec4899', '#10b981', '#f59e0b', '#ef4444'];

  if(type === 'jk') {
    labels = ['L','P']; data = [db.penduduk.filter(p=>p.jk==='L').length, db.penduduk.filter(p=>p.jk==='P').length];
  } else if(type === 'agama') {
    const agamas = [...new Set(db.penduduk.map(p=>p.agama))];
    labels = agamas; data = agamas.map(a => db.penduduk.filter(p=>p.agama===a).length);
  } else {
    const rts = [...new Set(db.penduduk.map(p=>p.rt))].sort();
    labels = rts.map(r => 'RT '+r); data = rts.map(r => db.penduduk.filter(p=>p.rt===r).length); chartType = 'bar';
  }

// Membuat objek grafik baru
  myChartInstance = new Chart(ctx, {
    type: chartType,
    data: { labels, datasets: [{ label: 'Jumlah Penduduk', data, backgroundColor: colors }] },
    options: { 
        responsive: true, 
        maintainAspectRatio: false,
        scales: chartType === 'bar' ? { y: { beginAtZero: true, ticks: { stepSize: 1 } } } : {}
    }
  });
}
</script>
</body>
</html>